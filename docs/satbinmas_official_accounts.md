# Satbinmas Official Account Management
*Last updated: 2025-11-24*

This document explains how Satbinmas official social-media handles are stored
and managed inside the Cicero backend. The feature introduces a dedicated table
that keeps official accounts separate from the legacy `client_insta` and
`client_tiktok` columns while staying linked to each client record.

## Database Structure
The `satbinmas_official_accounts` table is created by migration
`20251023_create_satbinmas_official_accounts.sql` and is also captured in the
canonical schema export. Additional metadata columns (`display_name`,
`profile_url`, `is_verified`) are layered on via
`20251206_enrich_satbinmas_official_account_metadata.sql`. Username uniqueness
per platform is enforced at the database level (case-insensitive) by
`20251207_enforce_unique_satbinmas_usernames.sql`.

| Column | Description |
|--------|-------------|
| `satbinmas_account_id` | UUID primary key generated by the database |
| `client_id` | Foreign key to `clients(client_id)` with cascade delete |
| `platform` | Lowercase platform label (e.g. `instagram`, `tiktok`) |
| `username` | Trimmed handle for the Satbinmas operator |
| `display_name` | Optional human-friendly label for the handle |
| `profile_url` | Optional public link to the profile |
| `is_active` | Boolean flag defaulting to `TRUE` |
| `is_verified` | Boolean flag defaulting to `FALSE` that tracks badge/verification status |
| `created_at` / `updated_at` | Timestamps maintained via trigger |

A unique constraint on `(client_id, platform)` prevents duplicate handles per
client/platform pair, while a trigger keeps `updated_at` fresh on each change.
An additional unique index on `(platform, LOWER(username))` disallows
case-insensitive duplicate usernames on the same platform across all clients, and
the migration removes older duplicates so the index can be created safely.【F:sql/migrations/20251023_create_satbinmas_official_accounts.sql†L1-L25】【F:sql/migrations/20251207_enforce_unique_satbinmas_usernames.sql†L1-L17】

## Model Layer
`src/model/satbinmasOfficialAccountModel.js` provides the data-access helpers
used by higher layers. Each reader returns the expanded metadata set (including
`display_name`, `profile_url`, and `is_verified`):

- `findByClientId(client_id)` returns all rows for a client ordered by platform.
- `findByClientIdAndPlatform(client_id, platform)` normalizes the platform name
  and retrieves a single row. This is used to determine if an upsert should be
  treated as an update.
- `findByPlatformAndUsername(platform, username)` normalizes inputs and detects
  a case-insensitive username conflict across clients for the same platform.
- `findById(accountId)` loads a single account when deleting.
- `upsertAccount({ client_id, platform, username, display_name?, profile_url?, is_active, is_verified })`
  performs an `INSERT ... ON CONFLICT` so that create and update share one code
  path while keeping the new metadata in sync.
- `removeById(accountId)` deletes the account and returns the removed row for
  audit purposes.【F:src/model/satbinmasOfficialAccountModel.js†L1-L84】

## Service Behaviour
`src/service/satbinmasOfficialAccountService.js` orchestrates validation and
business rules before calling the model:

1. All operations ensure the client exists before continuing.
2. `listSatbinmasOfficialAccounts` simply proxies to the model after the check.
3. `saveSatbinmasOfficialAccount` validates that `platform` and `username` are
   present, trims their values, normalizes the platform to lowercase, and keeps
   optional `display_name` and `profile_url` trimmed when provided. It applies
   `parseOptionalBoolean` to both `is_active` (defaulting to `true` when new) and
   `is_verified` (defaulting to `false` when new) so operators can send
   booleans, `0/1`, or strings like `yes/no`. When either boolean is omitted,
   the previous value (if any) is preserved. Username reuse across clients for
   the same platform is rejected up front (HTTP 409) and guarded in the database
   so callers receive a clear error instead of a generic constraint failure.
   The method returns both the stored row and a `created` flag so callers know
   whether a new record was inserted or updated.
4. `deleteSatbinmasOfficialAccount` checks the `satbinmas_account_id` belongs to
   the same client before removing it, ensuring operators cannot delete handles
   from other clients.【F:src/service/satbinmasOfficialAccountService.js†L1-L120】
5. `getSatbinmasOfficialAttendance` iterates through ORG clients and returns a
   simple attendance list containing `client_id`, `nama`, and boolean flags
   indicating whether an active Instagram or TikTok official account has been
   captured for each satker.【F:src/service/satbinmasOfficialAccountService.js†L141-L166】
6. Pada menu WhatsApp *Transfer & Laporan → Absensi Official Account*, daftar
   satker ditampilkan hanya dengan nama (tanpa `client_id`) serta status ikon
   Instagram/TikTok tanpa catatan "Perlu" agar tidak menampilkan metadata
   sensitif di grup. Format baris dibangun oleh helper
   `formatSatbinmasAttendanceEntry` sebelum dikirim ke pengguna.【F:src/handler/menu/clientRequestHandlers.js†L170-L189】【F:src/handler/menu/clientRequestHandlers.js†L4722-L4787】

## Controller & Routing
Three authenticated endpoints are exposed under the client routes namespace:

- `GET /api/client/:client_id/satbinmas-official` lists the existing handles for
  a client.
- `PUT /api/client/:client_id/satbinmas-official` upserts an account. The body
  accepts `{ platform, username, display_name?, profile_url?, is_active?, is_verified? }`.
- `DELETE /api/client/:client_id/satbinmas-official/:account_id` removes a
  handle linked to the client.【F:src/controller/clientController.js†L7-L105】【F:src/routes/clientRoutes.js†L1-L36】

Each controller method wraps service errors and returns either the row data or a
JSON error payload with the appropriate HTTP status code. Successful upserts use
HTTP `201 Created` when a new row is inserted so API consumers can react to the
change.

### Example Payloads
Both Instagram and TikTok are supported via the same endpoint. Example requests:

- Instagram upsert

```json
{
  "platform": "instagram",
  "username": "satbinmas",
  "display_name": "Akun Resmi Satbinmas",
  "profile_url": "https://instagram.com/satbinmas",
  "is_active": true,
  "is_verified": true
}
```

- TikTok upsert

```json
{
  "platform": "tiktok",
  "username": "satbinmas_official",
  "display_name": "Akun Resmi Satbinmas",
  "profile_url": "https://www.tiktok.com/@satbinmas_official",
  "is_active": true,
  "is_verified": false
}
```

### Error Responses
Attempting to reuse a username that already exists on the same platform (even
for a different client) results in a `409 Conflict`:

```json
{
  "message": "username already exists for this platform"
}
```

## WhatsApp Bot Entry Point
Operators can now add Satbinmas official Instagram **atau TikTok** accounts
directly from the WhatsApp bot via the client management menu:

1. Masuk menu *Client Request* → *Manajemen Client & User* → *Kelola client*.
2. Pilih client, lalu pilih opsi **5️⃣ Input Akun Resmi Satbinmas**.
3. Bot otomatis menetapkan peran akun menjadi `Akun Resmi Satbinmas` dan
   memakai *Client ID* aktif (berdasarkan nomor WhatsApp yang login). Jika perlu
   mengganti target, balas `kembali` untuk memasukkan Client ID lain.
4. Pilih platform: balas angka/menu kecil untuk **Instagram** atau **TikTok**
   sebelum mengisi username.
5. Ketik username sesuai platform (boleh diawali `@`). Bot memanggil RapidAPI
   `fetchInstagramInfo` atau `fetchTiktokProfile` untuk mengambil metadata
   akun.
6. Sistem mengisi `display_name` (gabungan peran + nama akun), `profile_url`,
   `is_active` (true jika profil ditemukan), serta `is_verified` (termasuk
   badge TikTok ketika tersedia), lalu menyimpan data melalui
   `satbinmasOfficialAccountService.saveSatbinmasOfficialAccount` ke tabel
   `satbinmas_official_accounts`.
7. Setelah penyimpanan sukses, bot menanyakan apakah operator ingin menambah
   akun official lainnya (`tambah`) atau memperbarui data yang sudah ada
   (`ubah`). Balasan `selesai`/`batal` kini langsung menutup sesi Satbinmas
   tanpa menampilkan ulang menu *Kelola Client*, sehingga percakapan selesai
   setelah permintaan tersebut dipenuhi.

Pesan yang dikirim lewat alur *WA Gateway* (`#satbinmasofficial`) kini memakai
dispatcher menu *clientrequest* yang sama, sehingga balasan angka seperti "1"
atau nama platform langsung diproses tanpa menggantung setelah memilih opsi
platform.

Balasan gateway merinci setiap akun resmi dalam format:

```
1. [Instagram] @username
   Status: Aktif
   Display Name: Satbinmas Kota
   Centang Biru: Sudah / Belum
   Link profile: https://instagram.com/username
```

`Link profile` otomatis menggunakan `profile_url` yang tersimpan atau dibangkitkan
dari username (dengan prefiks domain Instagram/TikTok) ketika URL kosong. URL yang
tidak memakai domain profil resmi (misalnya CDN foto Instagram) diabaikan dan
diganti tautan kanonik berdasarkan username.

Menu *Transfer & Laporan* kini menyediakan **Absensi Official Account** yang
menampilkan checklist ORG clients (Polres) dalam tiga kategori: ✅ *Lengkap*
(Instagram & TikTok aktif), ⚠️ *Kurang* (baru satu platform), dan ❌ *Belum*
(tidak ada akun aktif). Ringkasan jumlah per kategori ada di header, diikuti
detail tiap Polres beserta platform yang masih perlu dilengkapi. Header juga
memuat instruksi kepada Satbinmas Polres untuk mengirim data akun resmi via
WhatsApp ke `0812-3511-4745` menggunakan format berikut:

- `#SatbinmasOfficial`
- ikuti alur pengisian data sesuai respons sistem;
- tindakan dikirim oleh Operator.

Instruksi ini membantu memastikan tata kelola ruang digital yang konsisten dan
ketersediaan publikasi Satbinmas tetap terjaga.【F:src/handler/menu/clientRequestHandlers.js†L2109-L2159】【F:src/handler/menu/clientRequestHandlers.js†L4706-L4769】

Navigasi `batal` mengembalikan operator ke menu kelola client, sedangkan
`kembali` digunakan untuk mengulang instruksi input (Client ID/platform/username)
tanpa kehilangan sesi.

## Testing
`tests/satbinmasOfficialAccountService.test.js` covers the new service logic,
including:

- Listing behaviour and missing-client handling.
- Validation of required fields.
- Defaulting and preservation of the `is_active` flag.
- Boolean parsing for strings like `"yes"`.
- Deletion guardrails for missing IDs, unknown clients, and mismatched owners.
- The happy path for removal returning the deleted row.【F:tests/satbinmasOfficialAccountService.test.js†L1-L240】

Together, these tests ensure that the validation logic and status handling are
stable before exposing the endpoints to client applications.
