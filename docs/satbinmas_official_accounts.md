# Satbinmas Official Account Management
*Last updated: 2025-11-06*

This document explains how Satbinmas official social-media handles are stored
and managed inside the Cicero backend. The feature introduces a dedicated table
that keeps official accounts separate from the legacy `client_insta` and
`client_tiktok` columns while staying linked to each client record.

## Database Structure
The `satbinmas_official_accounts` table is created by migration
`20251023_create_satbinmas_official_accounts.sql` and is also captured in the
canonical schema export.

| Column | Description |
|--------|-------------|
| `satbinmas_account_id` | UUID primary key generated by the database |
| `client_id` | Foreign key to `clients(client_id)` with cascade delete |
| `platform` | Lowercase platform label (e.g. `instagram`, `tiktok`) |
| `username` | Trimmed handle for the Satbinmas operator |
| `is_active` | Boolean flag defaulting to `TRUE` |
| `created_at` / `updated_at` | Timestamps maintained via trigger |

A unique constraint on `(client_id, platform)` prevents duplicate handles per
platform, while a trigger keeps `updated_at` fresh on each change.【F:sql/migrations/20251023_create_satbinmas_official_accounts.sql†L1-L25】【F:sql/schema.sql†L17-L26】

## Model Layer
`src/model/satbinmasOfficialAccountModel.js` provides the data-access helpers
used by higher layers:

- `findByClientId(client_id)` returns all rows for a client ordered by platform.
- `findByClientIdAndPlatform(client_id, platform)` normalizes the platform name
  and retrieves a single row. This is used to determine if an upsert should be
  treated as an update.
- `findById(accountId)` loads a single account when deleting.
- `upsertAccount({ client_id, platform, username, is_active })` performs an
  `INSERT ... ON CONFLICT` so that create and update share one code path.
- `removeById(accountId)` deletes the account and returns the removed row for
  audit purposes.【F:src/model/satbinmasOfficialAccountModel.js†L1-L51】

## Service Behaviour
`src/service/satbinmasOfficialAccountService.js` orchestrates validation and
business rules before calling the model:

1. All operations ensure the client exists before continuing.
2. `listSatbinmasOfficialAccounts` simply proxies to the model after the check.
3. `saveSatbinmasOfficialAccount` validates that `platform` and `username` are
   present, trims their values, normalizes the platform to lowercase, and
   applies `parseOptionalBoolean` so operators can send booleans, `0/1`, or
   strings like `yes/no`. When `is_active` is omitted, the previous value (if
   any) is preserved; otherwise it defaults to `true` for new rows. The method
   returns both the stored row and a `created` flag so callers know whether a new
   record was inserted or updated.
4. `deleteSatbinmasOfficialAccount` checks the `satbinmas_account_id` belongs to
   the same client before removing it, ensuring operators cannot delete handles
   from other clients.【F:src/service/satbinmasOfficialAccountService.js†L1-L105】

## Controller & Routing
Three authenticated endpoints are exposed under the client routes namespace:

- `GET /api/client/:client_id/satbinmas-official` lists the existing handles for
  a client.
- `PUT /api/client/:client_id/satbinmas-official` upserts an account. The body
  accepts `{ platform, username, is_active? }`.
- `DELETE /api/client/:client_id/satbinmas-official/:account_id` removes a
  handle linked to the client.【F:src/controller/clientController.js†L7-L105】【F:src/routes/clientRoutes.js†L1-L36】

Each controller method wraps service errors and returns either the row data or a
JSON error payload with the appropriate HTTP status code. Successful upserts use
HTTP `201 Created` when a new row is inserted so API consumers can react to the
change.

## Testing
`tests/satbinmasOfficialAccountService.test.js` covers the new service logic,
including:

- Listing behaviour and missing-client handling.
- Validation of required fields.
- Defaulting and preservation of the `is_active` flag.
- Boolean parsing for strings like `"yes"`.
- Deletion guardrails for missing IDs, unknown clients, and mismatched owners.
- The happy path for removal returning the deleted row.【F:tests/satbinmasOfficialAccountService.test.js†L1-L214】

Together, these tests ensure that the validation logic and status handling are
stable before exposing the endpoints to client applications.
