# CICERO_V2
*Last updated: 2025-11-06*

## Description

**Cicero_V2** is an automation backend for monitoring social media, managing editorial workflows, and orchestrating WhatsApp messaging. The service ingests Instagram and TikTok metrics for multiple clients, tracks attendance, powers daily/weekly reporting, manages premium subscriptions, and now drives the Penmas editorial approval process. Two WhatsApp sessions are maintained—one for operator interactions and another as a gateway for directorate broadcasts—while OTP distribution has moved to instant email delivery.

The web dashboard lives in a separate Next.js repository, [Cicero_Web](https://github.com/cicero78M/Cicero_Web), which communicates with this API. Refer to [docs/combined_overview.md](docs/combined_overview.md) for how the repositories interact.

The full architecture is described in [docs/enterprise_architecture.md](docs/enterprise_architecture.md). Scheduled activities are listed in [docs/activity_schedule.md](docs/activity_schedule.md). See [docs/metadata_flow.md](docs/metadata_flow.md) for the data movement from collection to reporting. Additional guides are available for [server migration](docs/server_migration.md), [RabbitMQ](docs/rabbitmq.md), [Redis](docs/redis.md), [database structure](docs/database_structure.md), [premium subscriptions](docs/premium_subscription.md), [Nginx configuration](docs/reverse_proxy_config.md), [PostgreSQL backups](docs/pg_backup_gdrive.md), [naming conventions](docs/naming_conventions.md), [Login API guide](docs/login_api.md), [WhatsApp user registration guide](docs/wa_user_registration.md), [workflow & usage guide](docs/workflow_usage_guide.md), [editorial workflow](docs/wa_operator_request.md), and [analytics & feedback page design](docs/analyticsFeedbackPage.md).
Accepted complaint layouts, including `Kendala` and `Rincian Kendala` headers, are documented in [docs/complaint_formats.md](docs/complaint_formats.md).
Role-aware deactivation flows (per-role removal across WhatsApp menus and REST) are covered in [docs/user_role_deactivation.md](docs/user_role_deactivation.md).

## Key Capabilities

- Multi-tenant Instagram and TikTok ingestion with RapidAPI fallbacks and deduplication middleware for idempotent requests.
- Automated WhatsApp digests, OTP notifications via SMTP email, and Google Contacts synchronisation for administrator address books.
- Editorial event planning, press-release drafting, and approval logging exposed under Penmas-protected routes.
- Directorat WhatsApp dirrequest menus that now include an Instagram all-data recap export (menu 4️⃣2️⃣) spanning September-to-current months with per-polres totals.
- Premium subscription management, link amplification (regular and khusus), and directorate-level recap exports generated by cron buckets tied to WhatsApp readiness.
- Aggregated analytics APIs for dashboards, including combined operator, directorate, and complaint views.
- Client info responses on the WhatsApp *clientrequest* menu now include the Polda name derived from each client's `regional_id` for clearer regional context.

## Requirements
- Node.js 20 or newer
- PostgreSQL and Redis (configure `.env` accordingly)
- Run `npm install` before starting

---

## Folder Structure

```
Cicero_V2/
├── app.js                       # Application entry point
├── package.json                 # NPM configuration
├── src/
│   ├── config/                  # Environment and Redis config
│   ├── db/                      # Database adapters
│   ├── controller/              # Express controllers
│   ├── model/                   # Database models
│   ├── cron/                    # Scheduled jobs
│   ├── handler/                 # WhatsApp menu logic
│   ├── service/                 # Business services
│   ├── repository/              # Query helpers
│   ├── utils/                   # Utility functions
│   ├── routes/                  # Express routers
│   ├── middleware/              # Global middleware
│   └── data/                    # Static datasets (e.g. satker mappings)
├── laphar/                      # Legacy recap artefacts kept for reference
├── pegiat_medsos_apps/          # Android client (embedded reference copy)
└── tests/                       # Jest tests
```

---

## API Overview

The API exposes endpoints for managing clients and users, fetching Instagram and TikTok data, handling OAuth callbacks, orchestrating editorial events, and providing dashboard statistics. Dedicated routers cover aggregator widgets, directorate recap exports, complaint handling, Penmas press releases, premium requests, link amplification (regular and khusus), and OTP-powered data-claim flows. Detailed documentation for each route is available in the source code comments (`src/routes/**/*.js`).

Basic health checks are available without authentication. `GET` or `POST /` returns `{ "status": "ok" }` for load balancers or uptime probes, and `/_next/dev/` responds the same to keep Next.js dev proxies from spamming logs.

When a request requires data for a particular client, include the client's identifier as a query parameter:

```
GET /api/analytics?client_id=demo_client
```

This allows operators to scope responses to the correct client.

## Logging Timezone

Application logs are timestamped using the Asia/Jakarta timezone by the console wrapper in `src/utils/logger.js`. Expect log prefixes in the format `YYYY-MM-DDTHH:mm:ss.SSS+07:00` for consistent Jakarta-local monitoring.

## Deployment & Environment

1. **Clone and install dependencies**
    ```bash
    git clone <repo-url>
    cd Cicero_V2
    npm install
    ```
2. **Copy `.env.example` to `.env`** and update the values:
    ```ini
    PORT=3000
    DB_USER=cicero
    DB_HOST=localhost
    DB_NAME=cicero_db
    DB_PASS=secret
    DB_PORT=5432
    DB_DRIVER=postgres
    REDIS_URL=redis://localhost:6379
    ADMIN_WHATSAPP=628xxxxxx,628yyyyyy
    GATEWAY_WHATSAPP_ADMIN=628zzzzzz
    APP_SESSION_NAME=wa-admin
    USER_WA_CLIENT_ID=wa-userrequest
    GATEWAY_WA_CLIENT_ID=wa-gateway
    WA_WEB_VERSION_CACHE_URL=https://raw.githubusercontent.com/wppconnect-team/wa-version/main/last.json
    WA_WEB_VERSION=
    ENABLE_DIRREQUEST_GROUP=true
    CORS_ORIGIN=http://localhost:3000
    ALLOW_DUPLICATE_REQUESTS=false
    SECRET_KEY=your-secret
    JWT_SECRET=your-jwt-secret
    RAPIDAPI_KEY=xxxx
    AMQP_URL=amqp://localhost
    DEBUG_FETCH_INSTAGRAM=false
    GOOGLE_CONTACT_SCOPE=https://www.googleapis.com/auth/contacts
    GOOGLE_SERVICE_ACCOUNT=/path/to/service-account.json
    GOOGLE_IMPERSONATE_EMAIL=admin@example.com
    BACKUP_DIR=./backups
    GOOGLE_DRIVE_FOLDER_ID=your-drive-folder-id
    SMTP_HOST=smtp.example.com
    SMTP_PORT=587
    SMTP_USER=otp@example.com
    SMTP_PASS=super-secret
    SMTP_FROM="Cicero OTP" <otp@example.com>
    CONTACT_CACHE_TTL_MS=300000
    DASHBOARD_RESET_TOKEN_EXPIRY_MINUTES=15
    DASHBOARD_PASSWORD_RESET_URL=https://dashboard.example.com/reset
    DASHBOARD_URL=https://dashboard.example.com
    ADMIN_NOTIFY_LOGIN=true
    DIRREQUEST_ENGAGE_RANK_RECIPIENT=628xxxx@c.us
    LAPHAR_ARCHIVE=false
    ```
   Use `DB_DRIVER=postgres`, `postgresql`, or `pg` when connecting to Postgres so the backend applies the session settings (`app.current_*`) required by database row-level security. Switching `DB_DRIVER` to another value disables these Postgres-only settings.
   `ADMIN_WHATSAPP` accepts numbers with or without the `@c.us` suffix. When the suffix is omitted, the application automatically appends it.
   `USER_WA_CLIENT_ID` defines the session identifier used by the user-facing WhatsApp client. Change it to isolate session data if needed.
   `GATEWAY_WHATSAPP_ADMIN` identifies the WhatsApp account that receives gateway connection updates.
   `APP_SESSION_NAME` is the session folder name used for the main WhatsApp client; override it when running multiple instances on the same host.
   `WA_WEB_VERSION_CACHE_URL` points to a remote JSON document that whatsapp-web.js reads to align with the latest WhatsApp Web build; keep the default to avoid "update WhatsApp" browser errors, or swap in your own mirror if GitHub access is blocked. Set `WA_WEB_VERSION` to pin a specific version string from the JSON when the automatic cache path is unavailable.
   `ENABLE_DIRREQUEST_GROUP=false` disables all Ditbinmas dirRequest cron jobs at once while leaving other schedules intact.
   `GOOGLE_SERVICE_ACCOUNT` may be set to a JSON string or a path to a JSON file. If the value starts with `/` or ends with `.json`, the application reads the file; otherwise it parses the variable directly as JSON. `GOOGLE_IMPERSONATE_EMAIL` should be set to the Workspace user to impersonate when performing contact operations.
   `SMTP_*` variables enable OTP and complaint notifications through email (`claimRoutes.js`). Leave them unset to disable email delivery in development.
   `CONTACT_CACHE_TTL_MS` controls how long Google contact lookups stay cached in memory.
   `DASHBOARD_RESET_TOKEN_EXPIRY_MINUTES` and `DASHBOARD_PASSWORD_RESET_URL` customise dashboard password reset links.

3. **Set up Redis**
    ```bash
    sudo apt-get install redis-server
    sudo systemctl enable redis-server
    sudo systemctl start redis-server
    ```
4. **Set up RabbitMQ**
   ```bash
   sudo apt-get install rabbitmq-server
   sudo systemctl enable rabbitmq-server
   sudo systemctl start rabbitmq-server
   ```
5. **Initialize the database** using scripts in `sql/schema.sql`.
6. **Start the application**
    ```bash
    npm start
    ```
    Or with PM2:
    ```bash
    pm2 start app.js --name cicero_v2
    ```
7. **Lint & Test**
    ```bash
    npm run lint
    npm test
    ```

---

## Google Contacts Integration

The application can synchronize Google Workspace contacts using the People API. Contacts are cached in-memory based on `CONTACT_CACHE_TTL_MS` to reduce API churn, and stored phone numbers are reused by WhatsApp helpers. Configure the integration as follows:

1. **Enable the People API** in your Google Cloud project.
2. **Create a service account** and enable **Domain-wide delegation**.
3. **Grant domain-wide delegation** in the Google Admin console:
   - Note the service account's client ID.
   - Under **Security → API controls → Domain-wide delegation**, add a new client with that client ID and the scope defined in `GOOGLE_CONTACT_SCOPE`.
4. **Set environment variables**:
   - `GOOGLE_SERVICE_ACCOUNT` – JSON key or file path for the service account.
   - `GOOGLE_CONTACT_SCOPE` – OAuth scope for contacts, e.g. `https://www.googleapis.com/auth/contacts`.
   - `GOOGLE_IMPERSONATE_EMAIL` – Workspace user email to impersonate when accessing contacts.
   - `BACKUP_DIR` – temporary folder for local database dumps.
   - `GOOGLE_DRIVE_FOLDER_ID` – Google Drive folder ID to receive backups.

For detailed setup and usage examples, see [`docs/google_contacts_integration.md`](docs/google_contacts_integration.md).

---

## Database Backup & Backups to Drive

Example commands for backing up and restoring the database:

```bash
pg_dump -U <dbuser> -h <host> -d <dbname> > cicero_backup.sql
psql -U <dbuser> -h <host> -d <dbname> < cicero_backup.sql
```

A cron job (`src/cron/cronDbBackup.js`) runs daily at **04:00** (Asia/Jakarta), storing dumps in `BACKUP_DIR` and uploading them to the Drive folder defined by `GOOGLE_DRIVE_FOLDER_ID`. Backups reuse the same Google credentials used for contact sync.

---

## WhatsApp Sessions & Cron Buckets

Two WhatsApp sessions are launched from `app.js`: `waClient` for operator interactions and `waGatewayClient` for broadcast/reporting flows. Cron buckets remain paused until each session signals readiness, preventing duplicate schedules after restarts. Manifest entries in `src/cron/cronManifest.js` drive the always/`waClient` buckets, while all Ditbinmas dirRequest jobs are bundled in `src/cron/dirRequest/index.js` and registered via `registerDirRequestCrons(waGatewayClient)` so they share the same gateway context and can be toggled with `ENABLE_DIRREQUEST_GROUP`.

- The Instagram laphar cron (`cronInstaLaphar.js`) has been retired and removed from the manifest and seed data. New deployments will no longer register or seed this job; existing environments can safely drop its `cron_job_config` row if present.

- `src/cron/cronDirRequestCustomSequence.js` registers its own dirRequest job key with schedules at **15:00**, **18:00**, and **20:30** (Asia/Jakarta). Each run chains the social-media fetch (posts/likes/comments), dispatches Ditsamapta menus 6, 9, 28, and 29 to the Ditsamapta directorate targets (WhatsApp group, super admins, and operators), delivers the Ditbinmas menu 21 combined recap to the Ditbinmas WhatsApp group, then sends the Bidhumas menus 6 (IG likes), 9 (TikTok comments), 28 (likes per content), and 29 (Excel recap) reports to both the Bidhumas group and any configured super admin recipients. Admin WhatsApp numbers receive a short status summary after the sequence finishes.

- A combined Ditbinmas recap + custom chain (`DITBINMAS_RECAP_AND_CUSTOM_JOB_KEY`) now also runs at **20:30**. It fetches sosmed content/engagement first, executes the Ditbinmas recap (menus 6, 9, 34, 35 for super admins and 30 for operators), then reuses the same data to run the full custom sequence without re-fetching.

- The BIDHUMAS dispatch inside the custom and combined sequences still shares the **20:30** slot, remaining decoupled from the Ditbinmas recap that now fires at **20:33**.

- `src/cron/cronDirRequestBidhumasEvening.js` adds a **22:00** (Asia/Jakarta) BIDHUMAS-only cron that first runs `runDirRequestFetchSosmed()` and then executes dirRequest menus **6** and **9** specifically for the BIDHUMAS WhatsApp group and its super admin recipients. The job shares the dirRequest bucket and inherits the same WhatsApp readiness guardrails as the other dirRequest schedules.

The OTP worker (`src/service/otpQueue.js`) now resolves immediately because OTP emails are sent synchronously via SMTP to minimise delays.

---

## Troubleshooting

- **DB connection errors** – check database credentials and PostgreSQL status.
- **WhatsApp not connected** – rescan the QR code, confirm session folders (`APP_SESSION_NAME`, `USER_WA_CLIENT_ID`, `GATEWAY_WA_CLIENT_ID`), and check for unsupported version logs. If browser traces include `static.whatsapp.net` stack frames that mention updating WhatsApp, point `WA_WEB_VERSION_CACHE_URL` to a reachable mirror or pin `WA_WEB_VERSION` to the latest release from the cache JSON.
- **Email OTP delivery failed** – verify `SMTP_*` variables and network egress.
- **External API errors** – verify `RAPIDAPI_KEY` and check application logs.
- **Cron jobs not running** – confirm cron buckets activated after WhatsApp readiness and verify timezone settings (`Asia/Jakarta`).

---

## Security Notes

- Do not upload `.env` to a public repository.
- All POST/PUT endpoints perform strict validation.
- Only admins from the environment variables can trigger manual WhatsApp commands.
- Back up the database regularly and test recovery procedures.

## Request Deduplication

The middleware in [`src/middleware/dedupRequestMiddleware.js`](src/middleware/dedupRequestMiddleware.js) hashes non-GET requests and caches them in Redis for five minutes. Identical requests sent again within that window receive an HTTP 429 response. Claim endpoints under `/api/claim` are exempt so that the OTP flow can be retried without delay. Set `ALLOW_DUPLICATE_REQUESTS=true` to bypass this protection during development.

---

## Scaling & Monitoring

- Use PM2 clusters and separate processes if load is high.
- Monitor database health, cron jobs, and WhatsApp logs.
- Add indexes to frequently queried fields.
- Cache Instagram and TikTok profiles in Redis (`profileCacheService.js`) to improve response times.

## High Volume Queue (RabbitMQ)

- Use RabbitMQ to process large jobs asynchronously.
- Configure the connection URL in `AMQP_URL`.
- Implement helper functions (e.g. `publishToQueue` and `consumeQueue`) as needed for your project.

---

## License

See the LICENSE file in this repository.

## Contributors & Support

Contact the repository admin for access, issues, or additional contributors.

---

> This documentation is automatically generated based on code analysis and development history.
